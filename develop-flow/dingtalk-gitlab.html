<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>引入钉钉机器人通知 Gitlab CI/CD 的构建状态 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/learn-path-recording-and-coding/favicon.ico">
    <link rel="manifest" href="/learn-path-recording-and-coding/manifest.json">
    <link http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="apple-touch-icon" size="72x72" href="/learn-path-recording-and-coding/assets/images/apple-touch-icon-72.png">
    <meta name="description" content="一个记录个人学习的笔记">
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="author" content="camel_lu">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta name="keywords" content="笔记，知识点，回忆，前端，计算机，汇总">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/learn-path-recording-and-coding/assets/css/0.styles.7fdb3e19.css" as="style"><link rel="preload" href="/learn-path-recording-and-coding/assets/js/app.ffc21df9.js" as="script"><link rel="preload" href="/learn-path-recording-and-coding/assets/js/2.bfcbf030.js" as="script"><link rel="preload" href="/learn-path-recording-and-coding/assets/js/15.6e79ecc3.js" as="script"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/10.d1afa0f9.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/11.cc68f48d.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/12.559d4556.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/13.05bc9f00.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/14.22554b01.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/16.b7740180.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/17.d96310ab.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/18.a143247b.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/19.44419a4f.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/20.8631f014.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/21.ebb3f8b7.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/22.6b77ecbf.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/23.992afcf5.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/24.389110b9.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/25.480fbcee.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/26.ab36286d.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/27.5bc0df68.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/28.1439653b.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/29.05512e51.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/3.52eb7ca3.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/30.d20aed44.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/31.38e22a14.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/4.ebcdfb4f.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/5.63246833.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/6.e8dcb645.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/7.886196f3.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/8.41832a71.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/9.170c1e37.js">
    <link rel="stylesheet" href="/learn-path-recording-and-coding/assets/css/0.styles.7fdb3e19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-path-recording-and-coding/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://jackluson.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jackluson/learn-path-recording-and-coding" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://jackluson.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jackluson/learn-path-recording-and-coding" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Javascript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/javascript/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/javascript/browser.html" class="sidebar-link">About BOM and DOM 高级API</a></li><li><a href="/learn-path-recording-and-coding/javascript/eventloop.html" class="sidebar-link">EventLoop的理解</a></li><li><a href="/learn-path-recording-and-coding/javascript/further_eventloop.html" class="sidebar-link">EventLoop 的小记 -- 微任务是否造成页面阻塞</a></li><li><a href="/learn-path-recording-and-coding/javascript/js-engine.html" class="sidebar-link">JavaScript 运行原理细节</a></li><li><a href="/learn-path-recording-and-coding/javascript/design-patterns.html" class="sidebar-link">javascript 设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>持续集成&amp;自动化部署</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/develop-flow/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/develop-flow/gitlab-with-jenkins.html" class="sidebar-link">利用 Gitlab CI/CD + Jenkins 实现自动构建，自动部署</a></li><li><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html" aria-current="page" class="active sidebar-link">引入钉钉机器人通知 Gitlab CI/CD 的构建状态</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html#引入钉钉机器人" class="sidebar-link">引入钉钉机器人</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html#定制钉钉机器人" class="sidebar-link">定制钉钉机器人</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html#定制消息模板" class="sidebar-link">定制消息模板</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html#在之前的脚本中使用" class="sidebar-link">在之前的脚本中使用</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html#最后" class="sidebar-link">最后</a></li></ul></li><li><a href="/learn-path-recording-and-coding/develop-flow/travis-test.html" class="sidebar-link">Travis 认识及实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>框架&amp;库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/library/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/library/react-test-library.html" class="sidebar-link">react 项目单元测试技术方案</a></li><li><a href="/learn-path-recording-and-coding/library/vue-cli3-typescript.html" class="sidebar-link">如何引进 Typescript 到现存 Vue-cli3+项目中</a></li><li><a href="/learn-path-recording-and-coding/library/vuepress.html" class="sidebar-link">VuePress的学习&amp;实践</a></li><li><a href="/learn-path-recording-and-coding/library/babel-parser.html" class="sidebar-link">babel编译认识&amp;实践（demo）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>计算机基础&amp;原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/basics-principle/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/basics-principle/process-thread.html" class="sidebar-link">计算机的进程和线程的理解</a></li><li><a href="/learn-path-recording-and-coding/basics-principle/dns-hijack.html" class="sidebar-link">你需要知道的“DNS劫持”--web安全篇（1）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>技术实现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/tech/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/tech/real-time-video.html" class="sidebar-link">视频直播那些事</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>动效</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/effect/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/effect/percent-ring.html" class="sidebar-link">圆环百分比三种实现方式汇总</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="引入钉钉机器人通知-gitlab-ci-cd-的构建状态"><a href="#引入钉钉机器人通知-gitlab-ci-cd-的构建状态" class="header-anchor">#</a> 引入钉钉机器人通知 Gitlab CI/CD 的构建状态</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>本篇是之前写的<a href="https://www.yuque.com/docs/share/fd36e616-3df8-4e20-934d-9e129da3f15c" target="_blank" rel="noopener noreferrer">《利用 Gitlab CI/CD 实现自动构建，自动部署》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的续篇。我们知道 Gitlab 的 Pipeline 中的 Job 执行成功或者失败之后，对应 Job 状态会改变为 passedorfailed，当 Job 的状态改变之后， 我们需要再到 Gitlab CI/CD 的页面下查看 Job 的状态,去看看有没有打包完成。<br>实践表明，某些时候我们的 gitlab 执行 Job 往往需要等待很长且不稳定。导致我们反复到 CI/CD 的页面看看 Job 是否执行完毕。所以我们需要一个更友好，高效的 Job 执行完成状态的反馈方案。由此我想到了钉钉通知机器人。</p> <h2 id="引入钉钉机器人"><a href="#引入钉钉机器人" class="header-anchor">#</a> 引入钉钉机器人</h2> <p>其实就是在一个钉钉群引入 webhook 机器人，然后给你提供 token 和 secret， 依照指定的格式发起 http 请求就可以了</p> <blockquote><p>详情请看：<a href="https://ding-doc.dingtalk.com/doc#/serverapi3/iydd5h" target="_blank" rel="noopener noreferrer">https://ding-doc.dingtalk.com/doc#/serverapi3/iydd5h<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>官方文档解析很清楚，需要注意点就是需要加签这个步骤:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* 把timestamp+&quot;\n&quot;+密钥当做签名字符串，使用HmacSHA256算法计算签名，然后进行Base64 encode，\n
最后再把签名参数再进行urlEncode，得到最终的签名（需要使用UTF-8字符集）。
- 这里用node的crypto加密模块实现,大概实现如下
*/</span>
<span class="token keyword">const</span> <span class="token function-variable function">encryptSign</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">secret<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> str <span class="token operator">=</span> crypto
    <span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">&quot;sha256&quot;</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sign <span class="token operator">=</span> <span class="token function">encryptSign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>secret<span class="token punctuation">,</span> timestamp <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="定制钉钉机器人"><a href="#定制钉钉机器人" class="header-anchor">#</a> 定制钉钉机器人</h2> <p>钉钉机器人支持多种类型消息，我们需要的是一个文本和卡片类型消息，图片如下。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/365160/1628868307203-fb144850-5416-4e86-8435-b565fd9f53a8.png" alt="image.png"><br>结合钉钉文档，我们封装了自己的机器人 dingtalkBot 类,支持快速发送文本和卡片消息。脚本如下：</p> <p><a href="https://www.yuque.com/attachments/yuque/0/2020/js/365160/1594885981137-af51c06f-1b5e-4f93-9bee-86fbd845fb51.js?_lake_card=%7B%22uid%22%3A%221594885981113-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fjs%2F365160%2F1594885981137-af51c06f-1b5e-4f93-9bee-86fbd845fb51.js%22%2C%22name%22%3A%22dingtalkBot.js%22%2C%22size%22%3A2942%2C%22type%22%3A%22text%2Fjavascript%22%2C%22ext%22%3A%22js%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22HYfKA%22%2C%22card%22%3A%22file%22%7D" target="_blank" rel="noopener noreferrer">dingtalkBot.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/* eslint-disable @typescript-eslint/no-var-requires */</span>
<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;crypto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;axios&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">encryptSign</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">secret<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> str <span class="token operator">=</span> crypto
    <span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">&quot;sha256&quot;</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&quot;base64&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 钉钉机器人 WebHook：用于支持钉钉机器人消息发送
 *
 * 官方文档：https://ding-doc.dingtalk.com/doc#/serverapi2/qf2nxq
 */</span>
<span class="token keyword">class</span> <span class="token class-name">DingtalkBot</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 机器人工厂，所有的消息推送项目都会调用 this.webhook 接口进行发送
   *
   * @param {String} options.webhook 完整的接口地址
   * @param {String} options.baseUrl 接口地址
   * @param {String} options.accessToken accessToken
   * @param {String} options.secret secret
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>webhook <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>accessToken <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>baseUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Lack for arguments!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 优先使用 options.webhook</span>
    <span class="token comment">// 次之将由 options.baseUrl 和 options.accessToken 组合成一个 webhook 地址</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>webhook <span class="token operator">=</span>
      options<span class="token punctuation">.</span>webhook <span class="token operator">||</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>accessToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>secret <span class="token operator">=</span> options<span class="token punctuation">.</span>secret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 发送钉钉消息
   *
   * @param {Object} content 发动的消息对象
   * @return {Promise}
   */</span>
  <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> singStr <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>secret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      singStr <span class="token operator">=</span>
        <span class="token string">&quot;&amp;timestamp=&quot;</span> <span class="token operator">+</span>
        timestamp <span class="token operator">+</span>
        <span class="token string">&quot;&amp;sign=&quot;</span> <span class="token operator">+</span>
        <span class="token function">encryptSign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>secret<span class="token punctuation">,</span> timestamp <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webhook <span class="token operator">+</span> singStr<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;Content-Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 发送纯文本消息，支持@群内成员
   *
   * @param {String} content 消息内容
   * @param {Object} at 群内@成员的手机号
   * @return {Promise}
   */</span>
  <span class="token function">text</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> at</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    at <span class="token operator">=</span> at <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">msgtype</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        content<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      at<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 发送actionCard(动作卡片)
   * Ps: 支持多个按钮，支持Markdown
   *
   * @param {String} card.title 标题
   * @param {String} card.text 消息内容
   * @param {String} card.btnOrientation 按钮排列的方向(0竖直，1横向，默认为0)
   * @param {String} card.btn.title 某个按钮标题
   * @param {String} card.btn.actionURL 某个按钮链接
   * @return {Promise}
   */</span>
  <span class="token function">actionCard</span><span class="token punctuation">(</span><span class="token parameter">card</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">msgtype</span><span class="token operator">:</span> <span class="token string">&quot;actionCard&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">actionCard</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> card<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
        <span class="token literal-property property">text</span><span class="token operator">:</span> card<span class="token punctuation">.</span>text<span class="token punctuation">,</span>
        <span class="token literal-property property">btnOrientation</span><span class="token operator">:</span> card<span class="token punctuation">.</span>btnOrientation <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">btns</span><span class="token operator">:</span> card<span class="token punctuation">.</span>btns <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DingtalkBot<span class="token punctuation">;</span>
</code></pre></div><p><a name="L2ZPz"></a></p> <h2 id="定制消息模板"><a href="#定制消息模板" class="header-anchor">#</a> 定制消息模板</h2> <p>上面的消息类型我们知道，我们需要一些构建信息（项目，分支，环境等），还有需要@指定的提交人。经过折腾,我们知道 gitlab runner 执行 node 脚本时, process.env 这个变量下包含着我们需要的所有变量，如图所示<br><img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1594886819835-463cebea-4931-4e9b-be5e-9cc185045a49.png#align=left&amp;display=inline&amp;height=425&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=851&amp;originWidth=828&amp;size=83113&amp;status=done&amp;style=none&amp;width=414" alt="image.png"></p> <blockquote><p>上面的截图只是一部分</p></blockquote> <p><br>由此我们定义如下的 markdown 格式模板<br><img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1594887218007-f42e1eec-382f-4672-ac1a-3466dc622004.png#align=left&amp;display=inline&amp;height=265&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=528&amp;originWidth=505&amp;size=34798&amp;status=done&amp;style=none&amp;width=253" alt="image.png"><br>除了卡片消息之外。我们需要@通知指定提交人。依据钉钉提供的 API， 我们需要提交人的电话号码信息。那我们暴露提交人的电话号码信息在 node 执行 js 的时候呢。同样经过折腾，我们可以为项目设置环境变量，gitlab runner 执行 Job 时，就会暴露在其中执行环境中，详情看：<a href="https://docs.gitlab.com/help/ci/variables/README#variables" target="_blank" rel="noopener noreferrer">https://docs.gitlab.com/help/ci/variables/README#variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>例如：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1594888657442-a2045f4d-2b18-4398-9232-38a07d35cbb8.png#align=left&amp;display=inline&amp;height=413&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=413&amp;originWidth=1075&amp;size=39899&amp;status=done&amp;style=none&amp;width=1075" alt="image.png"><br>这里设置了 luxuemin 的变量名，变量值为我的号码：xxxxx。<br><strong>注意:这里存在映射关系, 变量名为 luxuemin, 是我的 gitlab 平台上的用户名,应该也是 git 的用户名，如图<img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1594888850206-e2b16981-e44f-43a3-b594-2dcedfb73338.png#align=left&amp;display=inline&amp;height=83&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=83&amp;originWidth=392&amp;size=5015&amp;status=done&amp;style=none&amp;width=392" alt="image.png"></strong><br><strong>配置好映射关系，我们就能@指定的提交人了。</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> gitlabUserName <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">GITLAB_USER_NAME</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> phoneNumber <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>gitlabUserName<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 在gitlab CI/CD上配置GITLAB_USER_NAME映射的电话号码</span>

<span class="token keyword">await</span> robot<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">&quot;请查收你的构建信息&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">atMobiles</span><span class="token operator">:</span> <span class="token punctuation">[</span>phoneNumber<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">isAtAll</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>发送消息脚本文件<a href="https://www.yuque.com/attachments/yuque/0/2020/js/365160/1594889373949-579ad1eb-73df-49f6-8044-a8456937bc75.js?_lake_card=%7B%22uid%22%3A%221594889374014-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fjs%2F365160%2F1594889373949-579ad1eb-73df-49f6-8044-a8456937bc75.js%22%2C%22name%22%3A%22notify.js%22%2C%22size%22%3A3757%2C%22type%22%3A%22text%2Fjavascript%22%2C%22ext%22%3A%22js%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%2288rNQ%22%2C%22card%22%3A%22file%22%7D" target="_blank" rel="noopener noreferrer">notify.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>上面的脚本文件还加了一个 Github Today Trending 的小彩蛋（随机推荐一个 github 的今日流行趋势项目），和随机一张养眼图片。</p></blockquote> <p>如图：<img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1594889577117-e90e172e-2326-4e0b-bada-dd0a40eec40d.png#align=left&amp;display=inline&amp;height=537&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=715&amp;originWidth=465&amp;size=152393&amp;status=done&amp;style=none&amp;width=349" alt="image.png"><br></p> <h2 id="在之前的脚本中使用"><a href="#在之前的脚本中使用" class="header-anchor">#</a> 在之前的脚本中使用</h2> <p>根据模拟 jenkins 请求的结果，node 执行上面的脚本之前，携带成功，失败状态，这里用 status 表示， 同时推出 js 脚本是，用 process.exit(status)退出，可参考下面脚本</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">RES</span><span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span> curl <span class="token operator">-</span><span class="token constant">X</span> <span class="token constant">POST</span> \
       <span class="token operator">--</span>user tao<span class="token operator">-</span>tao<span class="token operator">:</span>1169ee9c0493b27d915632c0577fdd66fd \
       <span class="token operator">--</span>data <span class="token string">'json={&quot;parameter&quot;:[{&quot;name&quot;:&quot;PJ&quot;,&quot;value&quot;:&quot;crm-finance-static&quot;},{&quot;name&quot;:&quot;MYENV&quot;, &quot;value&quot;:&quot;'</span>$env<span class="token string">'&quot;},{&quot;name&quot;:&quot;TAG&quot;,&quot;value&quot;:&quot;'</span>$branch<span class="token string">'&quot;}]}'</span> \
       <span class="token operator">--</span>compressed \
       <span class="token string">'http://xxxx/job/tao.tao/build?delay=0sec'</span> \
     <span class="token punctuation">)</span>
# <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;$RES&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then <span class="token punctuation">{</span> echo <span class="token string">'failed!'</span><span class="token punctuation">;</span> exit <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> fi
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;$RES&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then
  node scripts<span class="token operator">/</span>notify<span class="token punctuation">.</span>js $env $branch <span class="token operator">--</span>status<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token punctuation">{</span> echo <span class="token string">'failed!'</span><span class="token punctuation">;</span> exit <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">else</span>
  node scripts<span class="token operator">/</span>notify<span class="token punctuation">.</span>js $env $branch <span class="token operator">--</span>status<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{</span> echo <span class="token string">'succused!'</span><span class="token punctuation">;</span> exit <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
fi

</code></pre></div><p><a name="jUWv5"></a></p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>目前配置了 crm-finance 引入了这个机器人。后续需要的小伙伴可在自己的项目中引入，如果小伙伴想进入 Gitlab&amp;Dingtalk 通知机器人测试群，可扫码加入哈。热烈欢迎！<br><img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1594890417489-1e33a3a3-b365-4794-b031-903349cf5302.png#align=left&amp;display=inline&amp;height=369&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=736&amp;originWidth=537&amp;size=149438&amp;status=done&amp;style=none&amp;width=269" alt="image.png"></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/jackluson/learn-path-recording-and-coding/edit/master/docs/develop-flow/dingtalk-gitlab.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/13/2021, 3:27:13 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/learn-path-recording-and-coding/develop-flow/gitlab-with-jenkins.html" class="prev">
        利用 Gitlab CI/CD + Jenkins 实现自动构建，自动部署
      </a></span> <span class="next"><a href="/learn-path-recording-and-coding/develop-flow/travis-test.html">
        Travis 认识及实践
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/learn-path-recording-and-coding/assets/js/app.ffc21df9.js" defer></script><script src="/learn-path-recording-and-coding/assets/js/2.bfcbf030.js" defer></script><script src="/learn-path-recording-and-coding/assets/js/15.6e79ecc3.js" defer></script>
  </body>
</html>
