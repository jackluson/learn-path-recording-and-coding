<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>利用 Gitlab CI/CD + Jenkins 实现自动构建，自动部署 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/learn-path-recording-and-coding/favicon.ico">
    <link rel="manifest" href="/learn-path-recording-and-coding/manifest.json">
    <link http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="apple-touch-icon" size="72x72" href="/learn-path-recording-and-coding/assets/images/apple-touch-icon-72.png">
    <meta name="description" content="一个记录个人学习的笔记">
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="author" content="camel_lu">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta name="keywords" content="笔记，知识点，回忆，前端，计算机，汇总">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/learn-path-recording-and-coding/assets/css/0.styles.7fdb3e19.css" as="style"><link rel="preload" href="/learn-path-recording-and-coding/assets/js/app.ffc21df9.js" as="script"><link rel="preload" href="/learn-path-recording-and-coding/assets/js/2.bfcbf030.js" as="script"><link rel="preload" href="/learn-path-recording-and-coding/assets/js/16.b7740180.js" as="script"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/10.d1afa0f9.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/11.cc68f48d.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/12.559d4556.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/13.05bc9f00.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/14.22554b01.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/15.6e79ecc3.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/17.d96310ab.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/18.a143247b.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/19.44419a4f.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/20.8631f014.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/21.ebb3f8b7.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/22.6b77ecbf.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/23.992afcf5.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/24.389110b9.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/25.480fbcee.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/26.ab36286d.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/27.5bc0df68.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/28.1439653b.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/29.05512e51.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/3.52eb7ca3.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/30.d20aed44.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/31.38e22a14.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/4.ebcdfb4f.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/5.63246833.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/6.e8dcb645.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/7.886196f3.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/8.41832a71.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/9.170c1e37.js">
    <link rel="stylesheet" href="/learn-path-recording-and-coding/assets/css/0.styles.7fdb3e19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-path-recording-and-coding/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://jackluson.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jackluson/learn-path-recording-and-coding" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://jackluson.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jackluson/learn-path-recording-and-coding" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Javascript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/javascript/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/javascript/browser.html" class="sidebar-link">About BOM and DOM 高级API</a></li><li><a href="/learn-path-recording-and-coding/javascript/eventloop.html" class="sidebar-link">EventLoop的理解</a></li><li><a href="/learn-path-recording-and-coding/javascript/further_eventloop.html" class="sidebar-link">EventLoop 的小记 -- 微任务是否造成页面阻塞</a></li><li><a href="/learn-path-recording-and-coding/javascript/js-engine.html" class="sidebar-link">JavaScript 运行原理细节</a></li><li><a href="/learn-path-recording-and-coding/javascript/design-patterns.html" class="sidebar-link">javascript 设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>持续集成&amp;自动化部署</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/develop-flow/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/develop-flow/gitlab-with-jenkins.html" aria-current="page" class="active sidebar-link">利用 Gitlab CI/CD + Jenkins 实现自动构建，自动部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/gitlab-with-jenkins.html#模拟请求" class="sidebar-link">模拟请求</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/gitlab-with-jenkins.html#安排到-gitlab-上面" class="sidebar-link">安排到 gitlab 上面</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/gitlab-with-jenkins.html#忽略-gitlab-ci-yml-的作用" class="sidebar-link">忽略.gitlab-ci.yml 的作用</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/develop-flow/gitlab-with-jenkins.html#本地执行-ci-cd-脚本" class="sidebar-link">本地执行 CI/CD 脚本</a></li></ul></li><li><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html" class="sidebar-link">引入钉钉机器人通知 Gitlab CI/CD 的构建状态</a></li><li><a href="/learn-path-recording-and-coding/develop-flow/travis-test.html" class="sidebar-link">Travis 认识及实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>框架&amp;库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/library/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/library/react-test-library.html" class="sidebar-link">react 项目单元测试技术方案</a></li><li><a href="/learn-path-recording-and-coding/library/vue-cli3-typescript.html" class="sidebar-link">如何引进 Typescript 到现存 Vue-cli3+项目中</a></li><li><a href="/learn-path-recording-and-coding/library/vuepress.html" class="sidebar-link">VuePress的学习&amp;实践</a></li><li><a href="/learn-path-recording-and-coding/library/babel-parser.html" class="sidebar-link">babel编译认识&amp;实践（demo）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>计算机基础&amp;原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/basics-principle/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/basics-principle/process-thread.html" class="sidebar-link">计算机的进程和线程的理解</a></li><li><a href="/learn-path-recording-and-coding/basics-principle/dns-hijack.html" class="sidebar-link">你需要知道的“DNS劫持”--web安全篇（1）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>技术实现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/tech/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/tech/real-time-video.html" class="sidebar-link">视频直播那些事</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>动效</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/effect/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/effect/percent-ring.html" class="sidebar-link">圆环百分比三种实现方式汇总</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="利用-gitlab-ci-cd-jenkins-实现自动构建-自动部署"><a href="#利用-gitlab-ci-cd-jenkins-实现自动构建-自动部署" class="header-anchor">#</a> 利用 Gitlab CI/CD + Jenkins 实现自动构建，自动部署</h1> <p>本来只是想用 curl 去模拟触发部署静态资源的请求的。后来想到如果把这个操作交给 gitlab 操作岂不是更方便？ 所以这几天折腾了一下 gitlab 的 CI/CD,读了一些 gitlab 的官方文档，进一步完善了.gitlab-ci.yml。记录这个过程如下：</p> <h2 id="模拟请求"><a href="#模拟请求" class="header-anchor">#</a> 模拟请求</h2> <blockquote><p>利用 curl 命令行工具去模拟我们点击 <code>开始构建</code> 时那一时刻发起的第一个请求。</p></blockquote> <h3 id="第一个请求"><a href="#第一个请求" class="header-anchor">#</a> 第一个请求</h3> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1593768148367-d6c374ae-c772-4494-b8f8-3fc6c26ed8f0.png#align=left&amp;display=inline&amp;height=563&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=563&amp;originWidth=808&amp;size=58988&amp;status=done&amp;style=none&amp;width=808" alt="image.png">
经实践，第一个请求为上面的这个请求，重要参数是 json：xxx 和 Cookie，请求结果是一个 303 重定向。
<a name="XGAOu"></a></p> <h3 id="编写请求脚本"><a href="#编写请求脚本" class="header-anchor">#</a> 编写请求脚本</h3> <p>方便起见，首先用浏览器提供的方式，复制该请求。
<img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1593768350093-0da708c7-2e03-448d-bb7b-f8951e388695.png#align=left&amp;display=inline&amp;height=263&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=525&amp;originWidth=599&amp;size=61074&amp;status=done&amp;style=none&amp;width=300" alt="image.png">复制了整个请求之后，删除了一些不必要的参数之后，与提取 env， branch 这些变量之后， 得知下面的脚本</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">env</span><span class="token operator">=</span>uat
<span class="token assign-left variable">branch</span><span class="token operator">=</span>test

<span class="token function">curl</span> <span class="token string">'https://xxxx/job/tao.tao/build?delay=0sec'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-H</span> <span class="token string">'Cookie: JSESSIONID=8EF2BD7082FB37279EE93A3B7BB3ED25'</span> <span class="token punctuation">\</span>
  --data-raw <span class="token string">'json={&quot;parameter&quot;:[{&quot;name&quot;:&quot;PJ&quot;,&quot;value&quot;:&quot;crm-finance-static&quot;},{&quot;name&quot;:&quot;MYENV&quot;, &quot;value&quot;:&quot;'</span><span class="token variable">$env</span><span class="token string">'&quot;},{&quot;name&quot;:&quot;TAG&quot;,&quot;value&quot;:&quot;'</span><span class="token variable">$branch</span><span class="token string">'&quot;}]}'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--compressed</span>

</code></pre></div><p>上面的脚本是用 cookie 做用户认证的，既然是 cookie,就存在过期的可能。还好 Jenkins 提供了 token 的方法给用户。
具体看官方文档这两篇文章：
<a href="https://www.jenkins.io/doc/book/system-administration/authenticating-scripted-clients/" target="_blank" rel="noopener noreferrer">https://www.jenkins.io/doc/book/system-administration/authenticating-scripted-clients/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.jenkins.io/blog/2018/07/02/new-api-token-system/" target="_blank" rel="noopener noreferrer">https://www.jenkins.io/blog/2018/07/02/new-api-token-system/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>配置了 token 之后，修改之后脚本</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">env</span><span class="token operator">=</span>uat
<span class="token assign-left variable">branch</span><span class="token operator">=</span>test

<span class="token function">curl</span> <span class="token string">'https://xxxx/job/tao.tao/build?delay=0sec'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--user</span> tao-tao:1169ee9c0493b27d915632c0577fdd66fd <span class="token punctuation">\</span>
  --data-raw <span class="token string">'json={&quot;parameter&quot;:[{&quot;name&quot;:&quot;PJ&quot;,&quot;value&quot;:&quot;crm-finance-static&quot;},{&quot;name&quot;:&quot;MYENV&quot;, &quot;value&quot;:&quot;'</span><span class="token variable">$env</span><span class="token string">'&quot;},{&quot;name&quot;:&quot;TAG&quot;,&quot;value&quot;:&quot;'</span><span class="token variable">$branch</span><span class="token string">'&quot;}]}'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--compressed</span>

</code></pre></div><p>我们直接使用了 <code>sh 上面的脚本.sh</code>  执行，打开 jenkins 发布平台就可以看到有任务在执行了</p> <p><a name="KZ9kd"></a></p> <h2 id="安排到-gitlab-上面"><a href="#安排到-gitlab-上面" class="header-anchor">#</a> 安排到 gitlab 上面</h2> <blockquote><p>注：原来已经有了.gitlab-ci.yml 文件存在了，主要负责： 当我们 push 代码到 gitlab 仓库之后，自动执行 build 命令，并且复制到目标静态资源仓库中，之后再 push 到 gitlab 上</p></blockquote> <blockquote><p>不熟悉 gitlab 工作流的话，可以先看，开卷有益</p> <ol><li><a href="https://docs.gitlab.com/ee/ci/introduction/" target="_blank" rel="noopener noreferrer">https://docs.gitlab.com/ee/ci/introduction/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.gitlab.com/ce/ci/quick_start/README.html" target="_blank" rel="noopener noreferrer">https://docs.gitlab.com/ce/ci/quick_start/README.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></blockquote> <p>增加如下代码：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /^(test<span class="token punctuation">|</span>pre<span class="token punctuation">|</span>dev)$/
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> command <span class="token punctuation">-</span>v curl <span class="token punctuation">&gt;</span>/dev/null 2<span class="token punctuation">&gt;</span><span class="token important">&amp;1</span> <span class="token punctuation">|</span><span class="token punctuation">|</span> exit 1 <span class="token comment">#判断是否执行curl，否则推荐脚本</span>
    <span class="token punctuation">-</span> env=&quot;$REF_NAME&quot; <span class="token comment"># 默认env 与 分支名一致， 特殊处理uat --》 test</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&gt;</span><span class="token scalar string">
      if [ &quot;$REF_NAME&quot; == &quot;test&quot; ]; then
        env=&quot;uat&quot;
      fi</span>
    <span class="token punctuation">-</span> sh ./scripts/fetch<span class="token punctuation">-</span>jenkins.sh $env $REF_NAME <span class="token comment"># 执行脚本， 带上参数</span>
</code></pre></div><p>最初我是放在 after_script 中执行的，后来发现 after_script 即使脚本执行出错，gitlab 上面的 CI/CD/Pipelines 的 Job 的状态，照样是 passed 状态。
搜索得知 after_script 中是忽略失败的，如果需要支持的话，要另外安装脚本，具体可以看如下解释：<a href="https://gitlab.com/gitlab-org/gitlab-foss/-/issues/43010" target="_blank" rel="noopener noreferrer">https://gitlab.com/gitlab-org/gitlab-foss/-/issues/43010<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，所以我后面把它放在了 script 中，这样脚本出错的话，Job 的状态也是 failed 的状态（Job 失败的话，gitlab 还给我们发了邮件）</p> <hr> <p>另外，curl 只是模拟构建请求，但是我们如何判断请求成功还是失败的？前面我们说构建请求是返回 303 重定向的， 没有 response 内容回来，据此我们就可以判断，请求成功还是失败了，如果有请求结果的话，脚本就 exit 1</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$RES</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token punctuation">{</span> <span class="token builtin class-name">echo</span> <span class="token string">'failed!'</span><span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">fi</span>
</code></pre></div><p><code>.gitlab-ci.yml</code>  与 <code>fetch-jenkins.sh</code>  代码附件:
<a href="https://www.yuque.com/attachments/yuque/0/2020/yml/365160/1593771925625-835c8fda-6f86-4a8e-8270-dd43c182dbc6.yml?_lake_card=%7B%22uid%22%3A%221593771925609-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fyml%2F365160%2F1593771925625-835c8fda-6f86-4a8e-8270-dd43c182dbc6.yml%22%2C%22name%22%3A%22.gitlab-ci.yml%22%2C%22size%22%3A1712%2C%22type%22%3A%22%22%2C%22ext%22%3A%22yml%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22FIJyr%22%2C%22card%22%3A%22file%22%7D" target="_blank" rel="noopener noreferrer">.gitlab-ci.yml<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.yuque.com/attachments/yuque/0/2020/sh/365160/1593771950682-e5d84018-6882-4746-b001-082cb57a3565.sh?_lake_card=%7B%22uid%22%3A%221593771950767-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fsh%2F365160%2F1593771950682-e5d84018-6882-4746-b001-082cb57a3565.sh%22%2C%22name%22%3A%22fetch-jenkins.sh%22%2C%22size%22%3A602%2C%22type%22%3A%22text%2Fx-sh%22%2C%22ext%22%3A%22sh%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22GoS0f%22%2C%22card%22%3A%22file%22%7D" target="_blank" rel="noopener noreferrer">fetch-jenkins.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a name="O7ZU6"></a></p> <h2 id="忽略-gitlab-ci-yml-的作用"><a href="#忽略-gitlab-ci-yml-的作用" class="header-anchor">#</a> 忽略.gitlab-ci.yml 的作用</h2> <p>如果我们有一个这样的需要,在某一次 push,我不需要 gitlab 执行构建任务,或者我们觉得 gitlab 构建任务 pengding 太久, 或者 running 太慢。 如何解决这个痛点呢？</p> <p>这样，我们如果控制 push 代码的时候，携带信息通知 gitlab 服务器，达到我们想要的结果。</p> <p>很幸运，Gitlab CI/CD 是提供这个服务的，只不过有版本限制，
<img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1593772618316-6c282123-36bd-4ebb-87d0-68db0c2ec965.png#align=left&amp;display=inline&amp;height=498&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=498&amp;originWidth=918&amp;size=44078&amp;status=done&amp;style=stroke&amp;width=918" alt="image.png">
得知，我们的 gitlab runner 版本是<img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1593772742447-e585f11c-9f58-44f3-8a08-94a3d9a63537.png#align=left&amp;display=inline&amp;height=95&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=128&amp;originWidth=380&amp;size=23639&amp;status=done&amp;style=none&amp;width=283" alt="image.png">是支持 ci.skip。</p> <p>携带 <code>-o ci.skip</code> 之后 再 Pipelines 中就可以看到 ,如下图所示:跳过 job<img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1593772891052-6450b5d5-e7ac-4f6e-b95c-93b1cf5f67cd.png#align=left&amp;display=inline&amp;height=87&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=87&amp;originWidth=570&amp;size=8443&amp;status=done&amp;style=none&amp;width=570" alt="image.png"></p> <p><a name="bbnOT"></a></p> <h2 id="本地执行-ci-cd-脚本"><a href="#本地执行-ci-cd-脚本" class="header-anchor">#</a> 本地执行 CI/CD 脚本</h2> <blockquote><p>如果觉得 gitlab 构建速度太慢,结合我之前写的构建脚本,同样也可以实现自动构建,自动部署。</p></blockquote> <p>大概脚本如下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token shebang important">#!/usr/bin/env bash</span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-euo</span> pipefail
<span class="token assign-left variable">branch</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">curPath</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>
<span class="token assign-left variable">targetPath</span><span class="token operator">=</span><span class="token string">&quot;./build&quot;</span> <span class="token comment"># 打包静态资源路径配置, 为了统一推荐clone在源码根目录下的build文件夹(.gitignore 已忽略build)</span>
<span class="token assign-left variable">commitID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">git</span> rev-parse <span class="token parameter variable">--short</span> HEAD<span class="token variable">`</span></span> <span class="token comment"># get last commit SHA</span>
<span class="token assign-left variable">subModule</span><span class="token operator">=</span>finance
<span class="token assign-left variable">curBranch</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">git</span> symbolic-ref <span class="token parameter variable">--short</span> <span class="token parameter variable">-q</span> HEAD<span class="token variable">`</span></span> <span class="token comment"># get current branch</span>

<span class="token comment"># 首先判断是否在目标分支build</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$curBranch</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;<span class="token variable">$branch</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> -------------------------------------
    <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">&quot;<span class="token entity" title="\033">\033</span>[41;37m please checkout <span class="token variable">$branch</span> before building <span class="token entity" title="\033">\033</span>[0m&quot;</span>
    <span class="token builtin class-name">echo</span> -------------------------------------
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">cd</span> <span class="token string">&quot;<span class="token variable">$targetPath</span>&quot;</span>
<span class="token comment"># 获取分支名称</span>
<span class="token assign-left variable">targetBranch</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">git</span> symbolic-ref <span class="token parameter variable">--short</span> <span class="token parameter variable">-q</span> HEAD<span class="token variable">`</span></span>
<span class="token comment">#  判断是否在目标分支,不在的话checkout</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$targetBranch</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;<span class="token variable">$branch</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">git</span> checkout <span class="token string">&quot;<span class="token variable">$branch</span>&quot;</span>
<span class="token keyword">fi</span>

<span class="token function">git</span> pull
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token string">&quot;<span class="token variable">$targetPath</span>/<span class="token variable">$subModule</span>/&quot;</span>
<span class="token function">cp</span> <span class="token parameter variable">-r</span> <span class="token string">&quot;<span class="token variable">$curPath</span>/dist/<span class="token variable">$subModule</span>/&quot;</span> <span class="token string">&quot;./&quot;</span>


<span class="token assign-left variable">message</span><span class="token operator">=</span><span class="token string">&quot;deploy based on <span class="token variable">$branch</span> from <span class="token variable">$commitID</span>&quot;</span>

<span class="token comment"># set +e</span>
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">&quot;<span class="token variable">$message</span>&quot;</span>
<span class="token function">git</span> push <span class="token parameter variable">-u</span> origin

<span class="token builtin class-name">cd</span> -

<span class="token comment"># fetch jenkins interface</span>
<span class="token keyword">case</span> <span class="token variable">$branch</span> <span class="token keyword">in</span>
  dev  <span class="token punctuation">)</span> <span class="token assign-left variable">env</span><span class="token operator">=</span><span class="token string">&quot;dev&quot;</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token builtin class-name">test</span> <span class="token punctuation">)</span> <span class="token assign-left variable">env</span><span class="token operator">=</span><span class="token string">&quot;uat&quot;</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  pre <span class="token punctuation">)</span>  <span class="token assign-left variable">env</span><span class="token operator">=</span><span class="token string">&quot;pre&quot;</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  master <span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">&quot;<span class="token entity" title="\033">\033</span>[41;37m not support master <span class="token entity" title="\033">\033</span>[0m&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">exit</span> <span class="token number">0</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  *    <span class="token punctuation">)</span> <span class="token builtin class-name">echo</span> -------------------------------------
         <span class="token builtin class-name">echo</span> <span class="token parameter variable">-e</span> <span class="token string">&quot;<span class="token entity" title="\033">\033</span>[41;37m branch(<span class="token variable">$branch</span>) error before fetch jenkins <span class="token entity" title="\033">\033</span>[0m&quot;</span>
         <span class="token builtin class-name">echo</span> -------------------------------------
         <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">esac</span>

<span class="token function">sh</span> ./scripts/fetch-jenkins.sh <span class="token variable">$env</span> <span class="token variable">$branch</span> <span class="token comment"># 执行触发jenkins请求脚本</span>

</code></pre></div><p>附件如下：</p> <ul><li><a href="https://www.yuque.com/attachments/yuque/0/2020/sh/365160/1594003103252-ceeff864-c94e-4ed9-8c3d-a842a4b7f2f6.sh?_lake_card=%7B%22uid%22%3A%221594003103166-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fsh%2F365160%2F1594003103252-ceeff864-c94e-4ed9-8c3d-a842a4b7f2f6.sh%22%2C%22name%22%3A%22deploy.sh%22%2C%22size%22%3A1518%2C%22type%22%3A%22text%2Fx-sh%22%2C%22ext%22%3A%22sh%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22GujHr%22%2C%22card%22%3A%22file%22%7D" target="_blank" rel="noopener noreferrer">deploy.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.yuque.com/attachments/yuque/0/2020/sh/365160/1594003103562-0d3ca043-0f06-4990-9571-dee8a400f3ba.sh?_lake_card=%7B%22uid%22%3A%221594003103166-1%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Fsh%2F365160%2F1594003103562-0d3ca043-0f06-4990-9571-dee8a400f3ba.sh%22%2C%22name%22%3A%22fetch-jenkins.sh%22%2C%22size%22%3A602%2C%22type%22%3A%22text%2Fx-sh%22%2C%22ext%22%3A%22sh%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22Xpjed%22%2C%22card%22%3A%22file%22%7D" target="_blank" rel="noopener noreferrer">fetch-jenkins.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>然后 package.json 在配置如下
<img src="https://cdn.nlark.com/yuque/0/2020/png/365160/1593778259694-0e7219c1-ba50-4f99-9823-ad7669353cf4.png#align=left&amp;display=inline&amp;height=266&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=266&amp;originWidth=659&amp;size=32796&amp;status=done&amp;style=none&amp;width=659" alt="image.png"></p> <blockquote><p>直接执行 yarn deploy:dev 就帮助我们构建，push 到静态自然仓库，触发 jenkins 请求，部署到了 dev 了</p></blockquote> <p>最后，CI/CD 能有很多方式实现，有待大家挖掘， 这个也算是根据实际的项目情况，打通了 Jenkins，欢迎大家多多交流。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/jackluson/learn-path-recording-and-coding/edit/master/docs/develop-flow/gitlab-with-jenkins.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/9/2021, 2:45:49 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/learn-path-recording-and-coding/develop-flow/" class="prev router-link-active">
        Introduction
      </a></span> <span class="next"><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html">
        引入钉钉机器人通知 Gitlab CI/CD 的构建状态
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/learn-path-recording-and-coding/assets/js/app.ffc21df9.js" defer></script><script src="/learn-path-recording-and-coding/assets/js/2.bfcbf030.js" defer></script><script src="/learn-path-recording-and-coding/assets/js/16.b7740180.js" defer></script>
  </body>
</html>
