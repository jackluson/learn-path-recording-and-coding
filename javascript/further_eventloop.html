<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EventLoop 的小记 -- 微任务是否造成页面阻塞 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/learn-path-recording-and-coding/favicon.ico">
    <link rel="manifest" href="/learn-path-recording-and-coding/manifest.json">
    <link http-equiv="x-ua-compatible" content="ie=edge">
    <link rel="apple-touch-icon" size="72x72" href="/learn-path-recording-and-coding/assets/images/apple-touch-icon-72.png">
    <meta name="description" content="一个记录个人学习的笔记">
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="author" content="camel_lu">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta name="keywords" content="笔记，知识点，回忆，前端，计算机，汇总">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/learn-path-recording-and-coding/assets/css/0.styles.7fdb3e19.css" as="style"><link rel="preload" href="/learn-path-recording-and-coding/assets/js/app.ffc21df9.js" as="script"><link rel="preload" href="/learn-path-recording-and-coding/assets/js/2.bfcbf030.js" as="script"><link rel="preload" href="/learn-path-recording-and-coding/assets/js/23.992afcf5.js" as="script"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/10.d1afa0f9.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/11.cc68f48d.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/12.559d4556.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/13.05bc9f00.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/14.22554b01.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/15.6e79ecc3.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/16.b7740180.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/17.d96310ab.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/18.a143247b.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/19.44419a4f.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/20.8631f014.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/21.ebb3f8b7.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/22.6b77ecbf.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/24.389110b9.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/25.480fbcee.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/26.ab36286d.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/27.5bc0df68.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/28.1439653b.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/29.05512e51.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/3.52eb7ca3.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/30.d20aed44.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/31.38e22a14.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/4.ebcdfb4f.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/5.63246833.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/6.e8dcb645.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/7.886196f3.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/8.41832a71.js"><link rel="prefetch" href="/learn-path-recording-and-coding/assets/js/9.170c1e37.js">
    <link rel="stylesheet" href="/learn-path-recording-and-coding/assets/css/0.styles.7fdb3e19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-path-recording-and-coding/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://jackluson.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jackluson/learn-path-recording-and-coding" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://jackluson.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/jackluson/learn-path-recording-and-coding" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Javascript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/javascript/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/javascript/browser.html" class="sidebar-link">About BOM and DOM 高级API</a></li><li><a href="/learn-path-recording-and-coding/javascript/eventloop.html" class="sidebar-link">EventLoop的理解</a></li><li><a href="/learn-path-recording-and-coding/javascript/further_eventloop.html" aria-current="page" class="active sidebar-link">EventLoop 的小记 -- 微任务是否造成页面阻塞</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/javascript/further_eventloop.html#why" class="sidebar-link">Why</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/javascript/further_eventloop.html#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/javascript/further_eventloop.html#任务" class="sidebar-link">任务</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/javascript/further_eventloop.html#不同宿主环境" class="sidebar-link">不同宿主环境</a></li><li class="sidebar-sub-header"><a href="/learn-path-recording-and-coding/javascript/further_eventloop.html#reference" class="sidebar-link">Reference</a></li></ul></li><li><a href="/learn-path-recording-and-coding/javascript/js-engine.html" class="sidebar-link">JavaScript 运行原理细节</a></li><li><a href="/learn-path-recording-and-coding/javascript/design-patterns.html" class="sidebar-link">javascript 设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>持续集成&amp;自动化部署</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/develop-flow/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/develop-flow/gitlab-with-jenkins.html" class="sidebar-link">利用 Gitlab CI/CD + Jenkins 实现自动构建，自动部署</a></li><li><a href="/learn-path-recording-and-coding/develop-flow/dingtalk-gitlab.html" class="sidebar-link">引入钉钉机器人通知 Gitlab CI/CD 的构建状态</a></li><li><a href="/learn-path-recording-and-coding/develop-flow/travis-test.html" class="sidebar-link">Travis 认识及实践</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>框架&amp;库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/library/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/library/react-test-library.html" class="sidebar-link">react 项目单元测试技术方案</a></li><li><a href="/learn-path-recording-and-coding/library/vue-cli3-typescript.html" class="sidebar-link">如何引进 Typescript 到现存 Vue-cli3+项目中</a></li><li><a href="/learn-path-recording-and-coding/library/vuepress.html" class="sidebar-link">VuePress的学习&amp;实践</a></li><li><a href="/learn-path-recording-and-coding/library/babel-parser.html" class="sidebar-link">babel编译认识&amp;实践（demo）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>计算机基础&amp;原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/basics-principle/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/basics-principle/process-thread.html" class="sidebar-link">计算机的进程和线程的理解</a></li><li><a href="/learn-path-recording-and-coding/basics-principle/dns-hijack.html" class="sidebar-link">你需要知道的“DNS劫持”--web安全篇（1）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>技术实现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/tech/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/tech/real-time-video.html" class="sidebar-link">视频直播那些事</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>动效</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-path-recording-and-coding/effect/" class="sidebar-link">Introduction</a></li><li><a href="/learn-path-recording-and-coding/effect/percent-ring.html" class="sidebar-link">圆环百分比三种实现方式汇总</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="eventloop-的小记-微任务是否造成页面阻塞"><a href="#eventloop-的小记-微任务是否造成页面阻塞" class="header-anchor">#</a> EventLoop 的小记 -- 微任务是否造成页面阻塞</h1> <h2 id="why"><a href="#why" class="header-anchor">#</a> Why</h2> <p><code>Javascript</code> 是一门单线程语言，也就是同一时间只能执行一个任务。在浏览器环境中存在很多异步任务，比如<code>Promise</code>、事件回调、setTimeout 等这些异步任务。这些任务执行时间是不定的，满足一定的条件后就会调用这些异步回调函数。所以就需要一套机制来管理这些异步任务，不至于页面的阻塞。也就是<code>Eventloop</code>机制</p> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>其实 <code>eventloop</code> 就是一个不断循环的读取异步任务的机制，首先他有一套既定的规则：</p> <ol><li>首先检查同步任务有没有执行完(也就是调用栈是否为空)。</li> <li>如果为空的话，就去检查<code>micro task</code> (微任务)队列是否有任务，如果有的话就一次性把<code>micro task</code> (微任务)执行完为止（包括<code>micro task</code> (微任务)执行过程中再次生成微任务），直到<code>micro task</code> (微任务)队列为空再去检查宏任务 <code>macro task</code> (宏任务)队列。每执行完一个 <code>macro task</code> (宏任务)还要去检查<code>micro task</code> (微任务)队列是否为空，不为空的话先去把 micro task 队列清空。如此反复。</li></ol> <h2 id="任务"><a href="#任务" class="header-anchor">#</a> 任务</h2> <p>上面说了<code>micro task</code> 与 <code>macro task</code> 就是异步任务的分类。创建它们的 API 也是不一样的比如：</p> <p>创建<code>micro task</code> (微任务)的有<code>Promise</code>、<code>MutationObserver</code> 等</p> <p>创建 <code>macro task</code> (宏任务) 的有：<code>setTimeout</code>、 <code>setInterval</code>、<code>requestAnimationFrame</code> <code>MessageChannel</code>还有一些 IO 事件等(这里 rAF 有争议，但它绝对不是微任务）</p> <h3 id="任务表现差异"><a href="#任务表现差异" class="header-anchor">#</a> 任务表现差异</h3> <p>任务都是在调用栈中执行的，不断什么任务，单个任务是不能被中断的。</p> <p>关于<code>micro task</code> (微任务)与<code>macro task</code> (宏任务) 上面说了它们的执行顺序不一样，也就是微任务的优先级高。<strong>但是还有一个最重要的不同任务表现区别，也就是这篇文章最想要记录的 — 微任务会阻塞页面的渲染，给用户造成卡顿的感觉</strong>。<code>EventLoop类似的规则如下:</code></p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/977a2329b43f4012ab3af988ca760902~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p>可以看出直到把<code>micro task</code> (微任务)队列情况才去执行渲染，有关视频可以去<a href="https://www.youtube.com/watch?v=u1kqx6AenYw&amp;t=853s" target="_blank" rel="noopener noreferrer">事件循环的进一步探索 - Erin Zimmer - JSConf EU 2018<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 看</p> <p>我也做了一个 demo 验证上面的规则，确实如此：<a href="https://codepen.io/jackluson/pen/eYVgewE" target="_blank" rel="noopener noreferrer">Demo 跳转<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这个 demo 其实就是在 15 秒之内一直执行、创建微任务 or 宏任务。在这期间去点击页面交互、看页面是否及时渲染。结果发现只有 promise 才会造成页面的卡顿，其他都不会（基于这个原因我更倾向把 rAF 规律为宏任务）。此外 setTimeout 还有最小 4ms 的限制(第一次执行除外)。也就容易理解 React 调度器 scheduler 为什么用 MessageChanel 来实现还有 Vue 的 nextTick 因此 MessageChannel 是一对一通信，没有像 setTimeout 受到 4ms 限制，还有 rAF 受到浏览器渲染频率限制(16.6ms)。</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b536e6ca592d408aa7c20e57c7ac5493~tplv-k3u1fbpfcp-watermark.image?" alt="image.png"></p> <p>部分代码如下</p> <div class="language- extra-class"><pre class="language-text"><code>const button2 = document.querySelector('.btn2');
button2.addEventListener('click', () =&gt; {
    // 可以交互， 不会造成页面卡顿
    let pre = performance.now();
    let count = 0;
    const fn = () =&gt; {
      count++;
      if (count % 250 === 0) {
        console.log('count', count);
      }
      if (performance.now() - pre &lt; 1000 * 15) {
        setTimeout(() =&gt; {
          fn();
        }, 0);
      }
    };
    fn();
});
</code></pre></div><h2 id="不同宿主环境"><a href="#不同宿主环境" class="header-anchor">#</a> 不同宿主环境</h2> <p><code>JavaScript</code> 有不同的运行时环境，比如浏览器、Node、Web Worker 等各种环境也为<code>JS</code> 提供创建异步任务的 API。上面说的是浏览器环境，比如 Node 环境还有 <code>setImmediate</code> <code>process.nextTick</code> 等，不同环境 Eventloop 也有差别。这里不做重点介绍。</p> <h2 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h2> <ol><li><a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loop-processing-model" target="_blank" rel="noopener noreferrer">规范文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/jackluson/learn-path-recording-and-coding/edit/master/docs/javascript/further_eventloop.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/28/2022, 12:56:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/learn-path-recording-and-coding/javascript/eventloop.html" class="prev">
        EventLoop的理解
      </a></span> <span class="next"><a href="/learn-path-recording-and-coding/javascript/js-engine.html">
        JavaScript 运行原理细节
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/learn-path-recording-and-coding/assets/js/app.ffc21df9.js" defer></script><script src="/learn-path-recording-and-coding/assets/js/2.bfcbf030.js" defer></script><script src="/learn-path-recording-and-coding/assets/js/23.992afcf5.js" defer></script>
  </body>
</html>
